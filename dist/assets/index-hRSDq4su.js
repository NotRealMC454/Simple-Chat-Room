(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function l(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(t){if(t.ep)return;t.ep=!0;const s=l(t);fetch(t.href,s)}})();let a,r="",c="general",E=null,f=null,m=[];const h=document.getElementById("chat"),u=document.getElementById("msg"),B=document.getElementById("chat-header");window.onload=()=>{const e=localStorage.getItem("chatUsername");if(e){r=e;const n=document.getElementById("login-screen");n&&(n.style.display="none");const l=document.getElementById("app-layout");l&&(l.style.display="flex"),v()}};function U(e){const n=document.getElementById("auth-user").value.trim(),l=document.getElementById("auth-pass").value.trim();if(!n||!l)return alert("Enter both username and password.");localStorage.setItem("tempUser",n),localStorage.setItem("tempPass",l);const i=`ws://${window.location.host}`;a=new WebSocket(i),a.onopen=()=>{a.send(JSON.stringify({type:e,user:n,pass:l}))},a.onmessage=async t=>{const s=t.data instanceof Blob?await t.data.text():t.data,o=JSON.parse(s);if(o.type==="auth_success"){console.log("[DEBUG] auth_success received"),r=o.user,localStorage.setItem("chatUsername",r);const d=document.getElementById("login-screen");d&&(d.style.display="none");const C=document.getElementById("app-layout");C&&(C.style.display="flex"),a.send(JSON.stringify({type:"join",channel:c}))}else if(o.type==="auth_error"){console.log("[DEBUG] auth_error:",o.msg);const d=document.getElementById("auth-error");d&&(d.innerText=o.msg)}else if(o.type==="channels")console.log("[DEBUG] channels received:",o.channels),m=o.channels,p(m);else if(o.type==="channelCreated")console.log("[DEBUG] channelCreated received:",o.name),w(o.name);else if(o.type==="channelDeleted")console.log("[DEBUG] channelDeleted received:",o.name),c===o.name&&(c=m.find(d=>d!==o.name)||"general",B.innerText=`# ${c}`,u.placeholder=`Message #${c}...`),m=m.filter(d=>d!==o.name),p(m);else if(o.type==="history")console.log("[DEBUG] history received, message count:",o.messages?.length),h.innerHTML="",o.messages.forEach(d=>y(d));else if(o.type==="message")console.log("[DEBUG] message received from:",o.user),y(o);else if(o.type==="updateLikes"){console.log("[DEBUG] updateLikes received for msg:",o.id,"likes:",o.likes);const d=document.getElementById("like-"+o.id);d&&(d.innerText=`❤️ ${o.likes}`)}else console.log("[DEBUG] unknown message type:",o.type)}}function I(){localStorage.clear(),location.reload()}function G(){const e=document.getElementById("new-password").value.trim();if(!e)return alert("Enter a new password!");a.send(JSON.stringify({type:"change_password",user:r,newPass:e})),localStorage.setItem("chatPass",e);const n=document.getElementById("settings-modal");n&&(n.style.display="none")}function S(){const e=new(window.AudioContext||window.webkitAudioContext),n=e.createOscillator();n.connect(e.destination),n.frequency.setValueAtTime(800,e.currentTime),n.start(),n.stop(e.currentTime+.15)}function v(){if(r||(r=document.getElementById("auth-user")?.value?.trim()),!r)return alert("Please enter a username!");localStorage.setItem("chatUsername",r);const e=document.getElementById("login-screen");e&&(e.style.display="none");const n=`ws://${window.location.host}`;a=new WebSocket(n),a.onopen=()=>{a.send(JSON.stringify({type:"join",channel:c}))},a.onmessage=async l=>{const i=l.data instanceof Blob?await l.data.text():l.data,t=JSON.parse(i);if(t.type==="channels")console.log("[DEBUG joinChat] channels received:",t.channels),m=t.channels,p(m);else if(t.type==="channelCreated")console.log("[DEBUG joinChat] channelCreated received:",t.name),w(t.name);else if(t.type==="channelDeleted")console.log("[DEBUG joinChat] channelDeleted received:",t.name),c===t.name&&(c=m.find(s=>s!==t.name)||"general",B.innerText=`# ${c}`,u.placeholder=`Message #${c}...`),m=m.filter(s=>s!==t.name),p(m);else if(t.type==="history")console.log("[DEBUG joinChat] history received, message count:",t.messages?.length),h.innerHTML="",t.messages.forEach(s=>y(s));else if(t.type==="message")console.log("[DEBUG joinChat] message received from:",t.user),y(t);else if(t.type==="updateLikes"){console.log("[DEBUG joinChat] updateLikes received for msg:",t.id,"likes:",t.likes);const s=document.getElementById("like-"+t.id);s&&(s.innerText=`❤️ ${t.likes}`)}else console.log("[DEBUG joinChat] unknown message type:",t.type)}}function w(e,n){console.log("[DEBUG] switchChannel called:",e),c=e,document.querySelectorAll(".channel").forEach(l=>l.classList.remove("active")),n&&n.classList.add("active"),B.innerText=`# ${e}`,u.placeholder=`Message #${e}...`,console.log("[DEBUG] ws readyState:",a?.readyState,"OPEN:",WebSocket.OPEN),a&&a.readyState===WebSocket.OPEN?(console.log("[DEBUG] sending join message for channel:",e),a.send(JSON.stringify({type:"join",channel:c}))):console.log("[DEBUG] ws not ready, skipping join message")}let g=null;function p(e){console.log("[DEBUG] renderChannels called with:",e);const n=document.getElementById("channel-list");console.log("[DEBUG] channelsList found:",!!n),n&&(n.innerHTML="",e.forEach(l=>{const i=document.createElement("div");i.className="channel"+(c===l?" active":"");const t=document.createElement("span");if(t.innerText=`# ${l}`,t.style.flex="1",t.onclick=function(){w(l,i)},i.appendChild(t),l!=="general"){const s=document.createElement("span");s.innerText="✕",s.className="channel-delete-btn",s.onclick=function(o){o.stopPropagation(),D(l)},i.appendChild(s)}n.appendChild(i)}),console.log("[DEBUG] renderChannels done, rendered",e.length,"channels"))}function M(){console.log("[DEBUG] openAddChannelModal called");const e=document.getElementById("add-channel-name-input");console.log("[DEBUG] newChannelNameInput found:",!!e),e&&(e.value="");const n=document.getElementById("add-channel-modal");console.log("[DEBUG] addChannelModal found:",!!n),n&&(n.style.display="flex"),console.log("[DEBUG] modal display set to flex")}function D(e){console.log("[DEBUG] openDeleteChannelModal called for:",e),g=e;const n=document.getElementById("delete-channel-name");console.log("[DEBUG] deleteChannelName element found:",!!n),n&&(n.innerText=e);const l=document.getElementById("delete-channel-modal");console.log("[DEBUG] deleteChannelModal found:",!!l),l&&(l.style.display="flex")}function k(){console.log("[DEBUG] confirmDeleteChannel called, channelToDelete:",g),g&&(console.log("[DEBUG] sending deleteChannel ws message"),a.send(JSON.stringify({type:"deleteChannel",name:g})),g=null);const e=document.getElementById("delete-channel-modal");e&&(e.style.display="none")}function x(){console.log("[DEBUG] createChannel called");const e=document.getElementById("add-channel-name-input");console.log("[DEBUG] nameInput found:",!!e);const n=e?.value.trim()||"";if(console.log("[DEBUG] channel name:",n),!n){console.log("[DEBUG] empty name, returning");return}console.log("[DEBUG] sending createChannel ws message"),a.send(JSON.stringify({type:"createChannel",name:n}));const l=document.getElementById("add-channel-modal");l&&(l.style.display="none"),console.log("[DEBUG] createChannel done")}function T(e){console.log("[DEBUG] deleteChannel called:",e),a.send(JSON.stringify({type:"deleteChannel",name:e}))}function y(e){let n;try{n=atob(e.text)}catch{n=e.text}let l=!1;n.includes(`@${r}`)&&(l=!0,e.user!==r&&S());let i="";e.media&&(e.mediaType==="video"?i=`<video src="${e.media}" class="msg-media" controls></video>`:i=`<img src="${e.media}" class="msg-media">`),h.innerHTML+=`
                <div class="msg-block ${l?"highlight":""}" id="msg-${e.id}">
                    <span class="msg-user">${e.user}</span>
                    <div class="msg-text">${n}</div>
                    ${i}
                    <div class="msg-actions">
                        <button class="action-btn" id="like-${e.id}" onclick="likeMessage('${e.id}')">❤️ ${e.likes}</button>
                        <button class="action-btn" onclick="replyTo('${e.user}')">↩️ Reply</button>
                    </div>
                </div>
            `,h.scrollTop=h.scrollHeight}function $(){const e=document.getElementById("new-username");e&&(e.value=r);const n=document.getElementById("settings-modal");n&&(n.style.display="flex")}function O(){const e=document.getElementById("new-username").value.trim();if(e){r=e,localStorage.setItem("chatUsername",r);const n=document.getElementById("settings-modal");n&&(n.style.display="none")}}function L(e){a&&a.send(JSON.stringify({type:"like",channel:c,messageId:e}))}function b(e){u.value=`@${e} `+u.value,u.focus()}document.getElementById("file-upload").addEventListener("change",function(){const e=this.files?.[0];if(!e)return;if(e.size>52428800)return alert("File is too large! Max limit is 50MB.");const n=new FileReader;n.onload=function(l){E=l.target?.result,f=e.type.startsWith("video")?"video":"image",u.placeholder=`[${f} attached] Add a message...`},n.readAsDataURL(e)});u.addEventListener("keypress",function(e){e.key==="Enter"&&(u.value.trim()||E)&&a&&(f==="video"&&(u.placeholder="Uploading video... please wait."),a.send(JSON.stringify({type:"message",channel:c,user:r,text:btoa(u.value),media:E,mediaType:f})),u.value="",u.placeholder=`Message #${c}...`,E=null,f=null,document.getElementById("file-upload").value="")});window.authenticate=U;window.signOut=I;window.changePassword=G;window.joinChat=v;window.switchChannel=w;window.renderChannels=p;window.openAddChannelModal=M;window.openDeleteChannelModal=D;window.confirmDeleteChannel=k;window.createChannel=x;window.deleteChannel=T;window.appendMessage=y;window.openSettings=$;window.saveSettings=O;window.likeMessage=L;window.replyTo=b;
